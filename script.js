// –î–∞–Ω–Ω—ã–µ –∞–Ω–∏–º–µ
let animeList = [
    {
        title: "–ê—Ç–∞–∫–∞ –¢–∏—Ç–∞–Ω–æ–≤",
        studio: "Wit Studio, MAPPA",
        description: "–≠—Ä–µ–Ω –ô–µ–≥–µ—Ä –∏ –µ–≥–æ –¥—Ä—É–∑—å—è —Å—Ä–∞–∂–∞—é—Ç—Å—è —Å —Ç–∏—Ç–∞–Ω–∞–º–∏, —á—Ç–æ–±—ã –≤—ã–∂–∏—Ç—å –≤ –∂–µ—Å—Ç–æ–∫–æ–º –º–∏—Ä–µ. –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è, –∫–æ–≥–¥–∞ –≥–∏–≥–∞–Ω—Ç—Å–∫–∏–µ —Ç–∏—Ç–∞–Ω—ã –ø—Ä–æ—Ä—ã–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ —Å—Ç–µ–Ω—ã, –∑–∞—â–∏—â–∞—é—â–∏–µ —á–µ–ª–æ–≤–µ—á–µ—Å—Ç–≤–æ. –ì–ª–∞–≤–Ω—ã–π –≥–µ—Ä–æ–π, –≠—Ä–µ–Ω –ô–µ–≥–µ—Ä, –∫–ª—è–Ω–µ—Ç—Å—è —É–Ω–∏—á—Ç–æ–∂–∏—Ç—å –≤—Å–µ—Ö —Ç–∏—Ç–∞–Ω–æ–≤ –∏ —É–∑–Ω–∞—Ç—å –ø—Ä–∞–≤–¥—É –æ —Å–≤–æ–µ–º –º–∏—Ä–µ.",
        voiceType: "dub",
        voiceYear: 2023,
        poster: "https://via.placeholder.com/1000x1500/ffeef2/d63384?text=–ê—Ç–∞–∫–∞+–¢–∏—Ç–∞–Ω–æ–≤",
        voiceActors: [
            "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ - –≠—Ä–µ–Ω –ô–µ–≥–µ—Ä",
            "–ú–∞—Ä–∏—è –ü–µ—Ç—Ä–æ–≤–∞ - –ú–∏–∫–∞—Å–∞ –ê–∫–∫–µ—Ä–º–∞–Ω",
            "–ü–µ—Ç—Ä –°–∏–¥–æ—Ä–æ–≤ - –ê—Ä–º–∏–Ω –ê—Ä–ª–µ—Ä—Ç",
            "–ê–Ω–Ω–∞ –ö–æ–∑–ª–æ–≤–∞ - –õ–µ–≤–∏ –ê–∫–∫–µ—Ä–º–∞–Ω"
        ],
        rating: 4.5,
        isBest: true,
        seasons: [
            {
                name: "–°–µ–∑–æ–Ω 1",
                episodes: 25,
                link: "https://shikimori.one/animes/16498-shingeki-no-kyojin/season1"
            },
            {
                name: "–°–µ–∑–æ–Ω 2",
                episodes: 12,
                link: "https://shikimori.one/animes/16498-shingeki-no-kyojin/season2"
            },
            {
                name: "–°–µ–∑–æ–Ω 3",
                episodes: 22,
                link: "https://shikimori.one/animes/16498-shingeki-no-kyojin/season3"
            },
            {
                name: "–§–∏–Ω–∞–ª—å–Ω—ã–π —Å–µ–∑–æ–Ω",
                episodes: 28,
                link: "https://shikimori.one/animes/16498-shingeki-no-kyojin/final"
            }
        ],
        specials: [
            {
                name: "OVA: Ilse's Notebook",
                type: "OVA",
                episodes: 1,
                link: "https://shikimori.one/animes/16498-shingeki-no-kyojin/specials"
            },
            {
                name: "OVA: A Choice with No Regrets",
                type: "OVA", 
                episodes: 2,
                link: "https://shikimori.one/animes/16498-shingeki-no-kyojin/specials"
            }
        ],
        comments: [
            {
                author: "–ê–ª–µ–∫—Å–µ–π",
                avatar: "https://via.placeholder.com/40/ffeef2/d63384?text=A",
                text: "–û—Ç–ª–∏—á–Ω–∞—è –æ–∑–≤—É—á–∫–∞! –û—á–µ–Ω—å –ø–æ–Ω—Ä–∞–≤–∏–ª–∞—Å—å —Ä–∞–±–æ—Ç–∞ –∞–∫—Ç–µ—Ä–æ–≤.",
                date: "2024-01-15 14:30",
                rating: 5
            },
            {
                author: "–ú–∞—Ä–∏—è",
                avatar: "https://via.placeholder.com/40/ffeef2/d63384?text=M",
                text: "–°–º–æ—Ç—Ä–µ–ª–∞ –Ω–∞ –æ–¥–Ω–æ–º –¥—ã—Ö–∞–Ω–∏–∏, —Å–ø–∞—Å–∏–±–æ –∑–∞ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥—É–±–ª—è–∂!",
                date: "2024-01-16 09:15",
                rating: 4
            }
        ],
        commentRatings: {
            total: 2,
            average: 4.5,
            distribution: {5: 1, 4: 1, 3: 0, 2: 0, 1: 0}
        }
    },
    {
        title: "–í–∞–Ω –ü–∏—Å",
        studio: "Toei Animation",
        description: "–ü—Ä–∏–∫–ª—é—á–µ–Ω–∏—è –õ—É—Ñ—Ñ–∏ –∏ –µ–≥–æ –∫–æ–º–∞–Ω–¥—ã –ø–∏—Ä–∞—Ç–æ–≤ –≤ –ø–æ–∏—Å–∫–∞—Ö –≤–µ–ª–∏—á–∞–π—à–µ–≥–æ —Å–æ–∫—Ä–æ–≤–∏—â–∞ - –í–∞–Ω –ü–∏—Å. –ú–æ–Ω–∫–∏ –î. –õ—É—Ñ—Ñ–∏, –º–æ–ª–æ–¥–æ–π –ø–∏—Ä–∞—Ç —Å —Ç–µ–ª–æ–º —Ä–µ–∑–∏–Ω—ã –ø–æ—Å–ª–µ —Å—ä–µ–¥–µ–Ω–Ω–æ–≥–æ –î—å—è–≤–æ–ª—å—Å–∫–æ–≥–æ —Ñ—Ä—É–∫—Ç–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –≤ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–µ–µ –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ —á–µ—Ä–µ–∑ –ì—Ä–∞–Ω–¥ –õ–∞–π–Ω, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å –ö–æ—Ä–æ–ª–µ–º –ü–∏—Ä–∞—Ç–æ–≤.",
        voiceType: "recap",
        voiceYear: 2021,
        poster: "https://via.placeholder.com/1000x1500/ffeef2/d63384?text=–í–∞–Ω+–ü–∏—Å",
        voiceActors: [
            "–°–µ—Ä–≥–µ–π –ë–µ–ª–æ–≤ - –ú–æ–Ω–∫–∏ –î. –õ—É—Ñ—Ñ–∏",
            "–û–ª—å–≥–∞ –°–µ–º–µ–Ω–æ–≤–∞ - –ù–∞–º–∏",
            "–î–º–∏—Ç—Ä–∏–π –ù–æ–≤–∏–∫–æ–≤ - –†–æ—Ä–æ–Ω–æ–∞ –ó–æ—Ä–æ",
            "–ï–ª–µ–Ω–∞ –í–æ—Ä–æ–Ω–æ–≤–∞ - –í–∏–Ω—Å–º–æ–∫ –°–∞–Ω–¥–∂–∏"
        ],
        rating: 4.2,
        isBest: true,
        seasons: [
            {
                name: "–í–æ—Å—Ç–æ—á–Ω–æ–µ –°–∏–Ω–µ–µ –º–æ—Ä–µ",
                episodes: 61,
                link: "https://shikimori.one/animes/21-one-piece/season1"
            }
        ],
        specials: [
            {
                name: "–§–∏–ª—å–º: Strong World",
                type: "–§–∏–ª—å–º",
                episodes: 1,
                link: "https://shikimori.one/animes/3677-one-piece-movie-10-strong-world"
            }
        ],
        comments: [],
        commentRatings: {
            total: 0,
            average: 0,
            distribution: {5: 0, 4: 0, 3: 0, 2: 0, 1: 0}
        }
    },
    {
        title: "–ù–∞—Ä—É—Ç–æ",
        studio: "Studio Pierrot",
        description: "–ò—Å—Ç–æ—Ä–∏—è –æ —é–Ω–æ–º –Ω–∏–Ω–¥–∑—è –ù–∞—Ä—É—Ç–æ –£–∑—É–º–∞–∫–∏, –∫–æ—Ç–æ—Ä—ã–π –º–µ—á—Ç–∞–µ—Ç —Å—Ç–∞—Ç—å –•–æ–∫–∞–≥–µ - –ª–∏–¥–µ—Ä–æ–º —Å–≤–æ–µ–π –¥–µ—Ä–µ–≤–Ω–∏. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Ç–æ, —á—Ç–æ –≤ –Ω–µ–º –∑–∞–ø–µ—á–∞—Ç–∞–Ω –î–µ–≤—è—Ç–∏—Ö–≤–æ—Å—Ç—ã–π –¥–µ–º–æ–Ω-–ª–∏—Å, –ù–∞—Ä—É—Ç–æ –Ω–µ —Å–¥–∞–µ—Ç—Å—è –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —É–ø–æ—Ä–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å—Å—è, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∏—á—å —Å–≤–æ–µ–π —Ü–µ–ª–∏.",
        voiceType: "dub",
        voiceYear: 2018,
        poster: "https://via.placeholder.com/1000x1500/ffeef2/d63384?text=–ù–∞—Ä—É—Ç–æ",
        voiceActors: [
            "–ê–ª–µ–∫—Å–∞–Ω–¥—Ä –ù–æ–≤–∏–∫–æ–≤ - –ù–∞—Ä—É—Ç–æ –£–∑—É–º–∞–∫–∏",
            "–ï–∫–∞—Ç–µ—Ä–∏–Ω–∞ –°–µ–º–µ–Ω–æ–≤–∞ - –°–∞–∫—É—Ä–∞ –•–∞—Ä—É–Ω–æ",
            "–ú–∏—Ö–∞–∏–ª –ü–µ—Ç—Ä–æ–≤ - –°–∞—Å–∫–µ –£—á–∏—Ö–∞",
            "–û–ª—å–≥–∞ –ò–≤–∞–Ω–æ–≤–∞ - –ö–∞–∫–∞—à–∏ –•–∞—Ç–∞–∫–µ"
        ],
        rating: 4.0,
        isBest: false,
        seasons: [
            {
                name: "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ù–∞—Ä—É—Ç–æ",
                episodes: 220,
                link: "https://shikimori.one/animes/20-naruto/classic"
            },
            {
                name: "–ù–∞—Ä—É—Ç–æ: –£—Ä–∞–≥–∞–Ω–Ω—ã–µ —Ö—Ä–æ–Ω–∏–∫–∏",
                episodes: 500,
                link: "https://shikimori.one/animes/20-naruto/shippuden"
            }
        ],
        comments: [
            {
                author: "–î–º–∏—Ç—Ä–∏–π",
                avatar: "https://via.placeholder.com/40/ffeef2/d63384?text=D",
                text: "–ö–ª–∞—Å—Å–∏–∫–∞ –∂–∞–Ω—Ä–∞! –û—Ç–ª–∏—á–Ω–∞—è –æ–∑–≤—É—á–∫–∞, —Ä–µ–∫–æ–º–µ–Ω–¥—É—é –≤—Å–µ–º —Ñ–∞–Ω–∞—Ç–∞–º –∞–Ω–∏–º–µ.",
                date: "2024-01-10 18:45",
                rating: 4
            }
        ],
        commentRatings: {
            total: 1,
            average: 4.0,
            distribution: {5: 0, 4: 1, 3: 0, 2: 0, 1: 0}
        }
    },
    {
        title: "–•–æ–¥—è—á–∏–π –∑–∞–º–æ–∫",
        studio: "Studio Ghibli",
        description: "–ò—Å—Ç–æ—Ä–∏—è –æ —é–Ω–æ–π —à–ª—è–ø–Ω–∏—Ü–µ –°–æ—Ñ–∏, –∫–æ—Ç–æ—Ä–∞—è –ø–æ–ø–∞–¥–∞–µ—Ç –ø–æ–¥ –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∫–ª—è—Ç–∏—è –∏ –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ —Å—Ç–∞—Ä—É—Ö—É. –í –ø–æ–∏—Å–∫–∞—Ö —Å–ø–∞—Å–µ–Ω–∏—è –æ–Ω–∞ –∑–Ω–∞–∫–æ–º–∏—Ç—Å—è —Å –∑–∞–≥–∞–¥–æ—á–Ω—ã–º –≤–æ–ª—à–µ–±–Ω–∏–∫–æ–º –•–∞—É–ª–æ–º –∏ –µ–≥–æ –ø–µ—Ä–µ–¥–≤–∏–≥–∞—é—â–∏–º—Å—è –∑–∞–º–∫–æ–º.",
        voiceType: "offscreen",
        voiceYear: 2020,
        poster: "https://via.placeholder.com/1000x1500/ffeef2/d63384?text=–•–æ–¥—è—á–∏–π+–∑–∞–º–æ–∫",
        voiceActors: [
            "–ê–Ω–Ω–∞ –°–æ–∫–æ–ª–æ–≤–∞ - –°–æ—Ñ–∏",
            "–ò–≥–æ—Ä—å –ü–µ—Ç—Ä–æ–≤ - –•–∞—É–ª",
            "–ú–∞—Ä–∏—è –ö–æ–∑–ª–æ–≤–∞ - –ö–∞–ª—å—Ü–∏—Ñ–µ—Ä",
            "–°–µ—Ä–≥–µ–π –ù–æ–≤–∏–∫–æ–≤ - –ú–∞—Ä–∫–ª"
        ],
        rating: 4.8,
        isBest: true,
        seasons: [
            {
                name: "–ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è",
                episodes: 1,
                link: "https://shikimori.one/animes/430-howl-no-ugoku-shiro"
            }
        ],
        comments: [],
        commentRatings: {
            total: 0,
            average: 0,
            distribution: {5: 0, 4: 0, 3: 0, 2: 0, 1: 0}
        }
    }
];

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
const ADMIN_LOGIN = "admin";
const ADMIN_PASSWORD = "admin123";
let isAdmin = false;
let currentFilter = 'all';
let currentBestFilter = false;
let currentYearFilter = 'none';
let currentEditIndex = -1;
let currentCommentAnimeIndex = -1;
let currentUser = {
    username: "–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    avatar: "https://via.placeholder.com/80/ffeef2/d63384?text=AV",
    background: ""
};

// –î–µ–±–∞—É–Ω—Å –¥–ª—è –ø–æ–∏—Å–∫–∞
let searchTimeout;

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function deleteUserProfile() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –ø—Ä–æ—Ñ–∏–ª—å? –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ (–∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏) –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≤—Å–µ—Ö –∞–Ω–∏–º–µ
        animeList.forEach(anime => {
            if (anime.comments) {
                anime.comments = anime.comments.filter(comment => 
                    comment.author !== currentUser.username
                );
                // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                updateAnimeRating(anime);
            }
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        currentUser = {
            username: "–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
            avatar: "https://via.placeholder.com/80/ffeef2/d63384?text=AV",
            background: ""
        };
        
        // –û–±–Ω–æ–≤–ª—è–µ–º UI
        document.getElementById('usernameInput').value = '';
        document.getElementById('userAvatar').src = currentUser.avatar;
        
        // –£–±–∏—Ä–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω
        document.body.classList.remove('custom-bg');
        document.body.style.backgroundImage = '';
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
        saveToLocalStorage();
        saveUserToLocalStorage();
        displayAnimeList(animeList);
        
        showNotification('–ü—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª–µ–Ω! –í—Å–µ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã.');
    }
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
function saveUserProfile() {
    const usernameInput = document.getElementById('usernameInput');
    const username = usernameInput.value.trim();
    
    if (username) {
        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç –∏–º—è, –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ –µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
        const oldUsername = currentUser.username;
        if (oldUsername !== username && oldUsername !== "–ê–Ω–æ–Ω–∏–º–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å") {
            animeList.forEach(anime => {
                if (anime.comments) {
                    anime.comments.forEach(comment => {
                        if (comment.author === oldUsername) {
                            comment.author = username;
                        }
                    });
                }
            });
        }
        
        currentUser.username = username;
    }
    
    saveUserToLocalStorage();
    saveToLocalStorage();
    displayAnimeList(animeList);
    showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω! ‚úÖ');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–µ–π—Ç–∏–Ω–≥–∞ –∞–Ω–∏–º–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function updateAnimeRating(anime) {
    if (!anime.comments || anime.comments.length === 0) {
        anime.commentRatings = {
            total: 0,
            average: 0,
            distribution: {5: 0, 4: 0, 3: 0, 2: 0, 1: 0}
        };
        return;
    }
    
    const ratedComments = anime.comments.filter(comment => comment.rating);
    
    if (ratedComments.length === 0) {
        anime.commentRatings = {
            total: 0,
            average: 0,
            distribution: {5: 0, 4: 0, 3: 0, 2: 0, 1: 0}
        };
        return;
    }
    
    const total = ratedComments.length;
    const sum = ratedComments.reduce((acc, comment) => acc + comment.rating, 0);
    const average = total > 0 ? sum / total : 0;
    
    // –°—á–∏—Ç–∞–µ–º —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –æ—Ü–µ–Ω–æ–∫
    const distribution = {5: 0, 4: 0, 3: 0, 2: 0, 1: 0};
    ratedComments.forEach(comment => {
        if (comment.rating >= 1 && comment.rating <= 5) {
            distribution[comment.rating]++;
        }
    });
    
    anime.commentRatings = {
        total,
        average: Math.round(average * 10) / 10,
        distribution
    };
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥ –∞–Ω–∏–º–µ
    anime.rating = Math.round(average * 10) / 10;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞
function displayAnimeList(list) {
    const animeListElement = document.getElementById('animeList');
    animeListElement.innerHTML = '';
    
    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ –≥–æ–¥—É
    let sortedList = [...list];
    if (currentYearFilter === 'newest') {
        sortedList.sort((a, b) => b.voiceYear - a.voiceYear);
    } else if (currentYearFilter === 'oldest') {
        sortedList.sort((a, b) => a.voiceYear - b.voiceYear);
    }
    
    const filteredList = sortedList.filter(anime => {
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–∑–≤—É—á–∫–∏
        let typeMatch = true;
        if (currentFilter !== 'all') {
            typeMatch = anime.voiceType === currentFilter;
        }
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä "–õ—É—á—à–µ–µ"
        let bestMatch = true;
        if (currentBestFilter) {
            bestMatch = anime.isBest === true;
        }
        
        return typeMatch && bestMatch;
    });
    
    if (filteredList.length === 0) {
        animeListElement.innerHTML = `
            <div class="empty-state">
                <h3>üòî –ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã –∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –∞–Ω–∏–º–µ</p>
            </div>
        `;
        return;
    }
    
    filteredList.forEach((anime, index) => {
        const stars = '‚≠ê'.repeat(Math.round(anime.rating)) + '‚òÜ'.repeat(5 - Math.round(anime.rating));
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –∞–∫—Ç–µ—Ä–æ–≤ –æ–∑–≤—É—á–∫–∏
        let voiceActorsHTML = '';
        if (anime.voiceActors && anime.voiceActors.length > 0) {
            voiceActorsHTML = `
                <div class="voice-actors">
                    <div class="voice-actors-title">üé≠ –ê–∫—Ç–µ—Ä—ã –æ–∑–≤—É—á–∫–∏:</div>
                    ${anime.voiceActors.map(actor => `
                        <div class="voice-actor">‚Ä¢ ${actor}</div>
                    `).join('')}
                </div>
            `;
        }

        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–ø–µ—Ä–≤—ã–µ 2)
        const commentsHTML = generateCommentsHTML(anime, index, 2);
        const showMoreButton = anime.comments && anime.comments.length > 2 ? 
            `<button class="show-more-comments" onclick="showAllComments(${index})">
                üìñ –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (${anime.comments.length})
            </button>` : '';
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Å–µ–∑–æ–Ω–æ–≤
        const seasonsHTML = generateSeasonsHTML(anime, index);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Å–ø–µ—à–ª–æ–≤
        const specialsHTML = generateSpecialsHTML(anime, index);
        
        // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ü–µ–Ω–æ–∫
        const ratingStatsHTML = generateRatingStatsHTML(anime);
        
        const animeItem = document.createElement('div');
        animeItem.className = 'anime-item';
        animeItem.innerHTML = `
            <div class="anime-poster-container">
                <img src="${anime.poster}" alt="${anime.title}" class="anime-poster" 
                     onerror="this.src='https://via.placeholder.com/1000x1500/ffeef2/d63384?text=–ü–æ—Å—Ç–µ—Ä+–Ω–µ+–Ω–∞–π–¥–µ–Ω'">
                <div class="anime-actions">
                    ${seasonsHTML}
                    ${specialsHTML}
                    ${isAdmin ? `
                        <button class="edit-btn" onclick="editAnime(${index})">
                            ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                        </button>
                        <button class="delete-btn" onclick="deleteAnime(${index})">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    ` : ''}
                </div>
            </div>
            <div class="anime-content">
                <div class="anime-title">${anime.title}</div>
                <div class="anime-info">
                    <span class="studio">${anime.studio}</span>
                    <span class="voice-type ${anime.voiceType}">
                        ${getVoiceTypeText(anime.voiceType)}
                    </span>
                    <span class="voice-year">${anime.voiceYear} –≥–æ–¥</span>
                    ${anime.rating > 0 ? `
                        <span class="rating">${stars} (${anime.rating.toFixed(1)})</span>
                    ` : ''}
                </div>
                
                <div class="description">${anime.description}</div>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
                <div class="toggle-details" onclick="toggleDetails(this)">
                    üìã –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏
                </div>
                
                <!-- –°–µ–∫—Ü–∏—è —Å –∞–∫—Ç–µ—Ä–∞–º–∏ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è–º–∏ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="details-section">
                    ${voiceActorsHTML}
                    
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ü–µ–Ω–æ–∫ -->
                    ${ratingStatsHTML}
                    
                    <!-- –°–µ–∫—Ü–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                    <div class="comments-section">
                        <div class="comments-title" onclick="toggleComments(this)">
                            üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ 
                            <span style="font-size: 12px; color: #868e96;">(${anime.comments ? anime.comments.length : 0})</span>
                        </div>
                        
                        <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                        <div class="comment-form">
                            <textarea class="comment-input" placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π..." id="commentInput-${index}"></textarea>
                            <button class="submit-comment" onclick="openCommentRatingModal(${index})">
                                ‚≠ê –û—Ü–µ–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å
                            </button>
                        </div>
                        
                        <!-- –°–ø–∏—Å–æ–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ -->
                        <div class="comments-list">
                            ${commentsHTML}
                        </div>
                        ${showMoreButton}
                    </div>
                </div>
            </div>
        `;
        animeListElement.appendChild(animeItem);
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—Ü–µ–Ω–æ–∫
function generateRatingStatsHTML(anime) {
    if (!anime.commentRatings || anime.commentRatings.total === 0) {
        return '';
    }
    
    const { total, average, distribution } = anime.commentRatings;
    const percentage = (rating) => {
        return total > 0 ? (distribution[rating] / total) * 100 : 0;
    };
    
    return `
        <div class="comment-rating-section">
            <div class="comment-rating-title">‚≠ê –û—Ü–µ–Ω–∫–∏ –∑—Ä–∏—Ç–µ–ª–µ–π (${total} –æ—Ü–µ–Ω–æ–∫)</div>
            <div class="comment-rating-stats">
                <div style="font-weight: bold; color: #d63384; font-size: 14px;">
                    ${average.toFixed(1)}/5
                </div>
                <div class="rating-progress">
                    <div class="rating-progress-fill" style="width: ${(average / 5) * 100}%"></div>
                </div>
                <div style="color: #868e96; font-size: 11px;">
                    ${total} –æ—Ü–µ–Ω–æ–∫
                </div>
            </div>
            <div class="rating-distribution">
                ${[5, 4, 3, 2, 1].map(rating => `
                    <div class="rating-bar">
                        <div class="rating-bar-label">${rating}</div>
                        <div class="rating-bar-progress">
                            <div class="rating-bar-fill" style="width: ${percentage(rating)}%"></div>
                        </div>
                        <div class="rating-bar-count">${distribution[rating]}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Å–µ–∑–æ–Ω–æ–≤
function generateSeasonsHTML(anime, index) {
    if (!anime.seasons || anime.seasons.length === 0) {
        return `<a href="#" class="watch-btn" style="background: #ffe3e3; color: #fa5252;">‚ö†Ô∏è –ù–µ—Ç —Å–µ–∑–æ–Ω–æ–≤</a>`;
    }
    
    if (anime.seasons.length === 1) {
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–µ–∑–æ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
        return `<a href="${anime.seasons[0].link}" target="_blank" class="watch-btn">üé¨ –°–º–æ—Ç—Ä–µ—Ç—å</a>`;
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∑–æ–Ω–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
        const seasonsList = anime.seasons.map((season, seasonIndex) => `
            <div class="season-item" onclick="window.open('${season.link}', '_blank')">
                <div class="season-name">${season.name}</div>
                <div class="season-episodes">${season.episodes} —ç–ø–∏–∑–æ–¥–æ–≤</div>
            </div>
        `).join('');
        
        return `
            <div class="seasons-dropdown">
                <div class="watch-btn" onclick="toggleSeasonsMenu(this)">
                    üé¨ –°–º–æ—Ç—Ä–µ—Ç—å (${anime.seasons.length} —Å–µ–∑–æ–Ω–æ–≤)
                </div>
                <div class="seasons-menu">
                    ${seasonsList}
                </div>
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML —Å–ø–µ—à–ª–æ–≤
function generateSpecialsHTML(anime, index) {
    if (!anime.specials || anime.specials.length === 0) {
        return '';
    }
    
    if (anime.specials.length === 1) {
        // –ï—Å–ª–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Å–ø–µ—à–ª, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
        return `<a href="${anime.specials[0].link}" target="_blank" class="specials-btn">üé¨ ${anime.specials[0].type}</a>`;
    } else {
        // –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–ø–µ—à–ª–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–ø–∞–¥–∞—é—â–µ–µ –º–µ–Ω—é
        const specialsList = anime.specials.map((special, specialIndex) => `
            <div class="special-item" onclick="window.open('${special.link}', '_blank')">
                <div class="special-name">${special.name}</div>
                <div class="special-type">${special.type} ‚Ä¢ ${special.episodes} —ç–ø.</div>
            </div>
        `).join('');
        
        return `
            <div class="specials-dropdown">
                <div class="specials-btn" onclick="toggleSpecialsMenu(this)">
                    üé¨ OVA/–°–ø–µ—à–ª—ã (${anime.specials.length})
                </div>
                <div class="specials-menu">
                    ${specialsList}
                </div>
            </div>
        `;
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HTML –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function generateCommentsHTML(anime, index, limit = null) {
    if (!anime.comments || anime.comments.length === 0) {
        return '<div class="no-comments">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!</div>';
    }
    
    const commentsToShow = limit ? anime.comments.slice(0, limit) : anime.comments;
    
    return commentsToShow.map((comment, commentIndex) => {
        const isCurrentUserComment = comment.author === currentUser.username;
        const editDeleteButtons = isCurrentUserComment ? `
            <button class="edit-comment-btn" onclick="editComment(${index}, ${commentIndex})">‚úèÔ∏è</button>
            <button class="delete-comment-btn" onclick="deleteComment(${index}, ${commentIndex})">√ó</button>
        ` : (isAdmin ? `<button class="delete-comment-btn" onclick="deleteComment(${index}, ${commentIndex})">√ó</button>` : '');
        
        const ratingBadge = comment.rating ? `
            <span class="comment-rating-badge">
                ‚≠ê ${comment.rating}/5
            </span>
        ` : '';
        
        return `
            <div class="comment-item" id="comment-${index}-${commentIndex}">
                ${editDeleteButtons}
                <div class="comment-author">
                    <img src="${comment.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" class="author-avatar">
                    ${comment.author}
                    ${ratingBadge}
                </div>
                <div class="comment-text">${comment.text}</div>
                <div class="comment-date">${formatDate(comment.date)}</div>
            </div>
        `;
    }).join('');
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–Ω—é —Å–µ–∑–æ–Ω–æ–≤
function toggleSeasonsMenu(element) {
    const menu = element.nextElementSibling;
    const isVisible = menu.classList.contains('show');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω—é
    document.querySelectorAll('.seasons-menu.show').forEach(openMenu => {
        if (openMenu !== menu) {
            openMenu.classList.remove('show');
        }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
    if (isVisible) {
        menu.classList.remove('show');
    } else {
        menu.classList.add('show');
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–Ω—é —Å–ø–µ—à–ª–æ–≤
function toggleSpecialsMenu(element) {
    const menu = element.nextElementSibling;
    const isVisible = menu.classList.contains('show');
    
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—Ç–∫—Ä—ã—Ç—ã–µ –º–µ–Ω—é
    document.querySelectorAll('.specials-menu.show').forEach(openMenu => {
        if (openMenu !== menu) {
            openMenu.classList.remove('show');
        }
    });
    
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –º–µ–Ω—é
    if (isVisible) {
        menu.classList.remove('show');
    } else {
        menu.classList.add('show');
    }
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–µ–Ω—é –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
document.addEventListener('click', function(e) {
    if (!e.target.closest('.seasons-dropdown')) {
        document.querySelectorAll('.seasons-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
    if (!e.target.closest('.specials-dropdown')) {
        document.querySelectorAll('.specials-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }
});

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å–µ–∑–æ–Ω–æ–≤
function addSeason(seasonData = null) {
    const seasonsList = document.getElementById('seasonsList');
    const seasonIndex = seasonsList.children.length;
    
    const seasonEditor = document.createElement('div');
    seasonEditor.className = 'season-editor-item';
    seasonEditor.innerHTML = `
        <div class="season-editor-header">
            <div class="season-number">–°–µ–∑–æ–Ω ${seasonIndex + 1}</div>
            <button type="button" class="remove-season-btn" onclick="removeSeason(this)">√ó</button>
        </div>
        <div class="season-fields">
            <div class="season-field">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ–∑–æ–Ω–∞</label>
                <input type="text" class="season-name" value="${seasonData ? seasonData.name : `–°–µ–∑–æ–Ω ${seasonIndex + 1}`}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–µ–∑–æ–Ω 1">
            </div>
            <div class="season-field">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–∏–∑–æ–¥–æ–≤</label>
                <input type="number" class="season-episodes" value="${seasonData ? seasonData.episodes : 12}" min="1" max="1000">
            </div>
            <div class="season-field full-width">
                <label>–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</label>
                <input type="url" class="season-link" value="${seasonData ? seasonData.link : ''}" placeholder="https://example.com/season1">
            </div>
        </div>
    `;
    
    seasonsList.appendChild(seasonEditor);
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Å–ø–µ—à–ª–æ–≤
function addSpecial(specialData = null) {
    const specialsList = document.getElementById('specialsList');
    const specialIndex = specialsList.children.length;
    
    const specialEditor = document.createElement('div');
    specialEditor.className = 'season-editor-item';
    specialEditor.innerHTML = `
        <div class="season-editor-header">
            <div class="season-number">–°–ø–µ—à–ª ${specialIndex + 1}</div>
            <button type="button" class="remove-season-btn" onclick="removeSpecial(this)">√ó</button>
        </div>
        <div class="season-fields">
            <div class="season-field">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                <input type="text" class="special-name" value="${specialData ? specialData.name : `–°–ø–µ—à–ª ${specialIndex + 1}`}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: OVA 1">
            </div>
            <div class="season-field">
                <label>–¢–∏–ø</label>
                <select class="special-type">
                    <option value="OVA" ${specialData && specialData.type === 'OVA' ? 'selected' : ''}>OVA</option>
                    <option value="ONA" ${specialData && specialData.type === 'ONA' ? 'selected' : ''}>ONA</option>
                    <option value="–§–∏–ª—å–º" ${specialData && specialData.type === '–§–∏–ª—å–º' ? 'selected' : ''}>–§–∏–ª—å–º</option>
                    <option value="–°–ø–µ—à–ª" ${specialData && specialData.type === '–°–ø–µ—à–ª' ? 'selected' : ''}>–°–ø–µ—à–ª</option>
                </select>
            </div>
            <div class="season-field">
                <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ø–∏–∑–æ–¥–æ–≤</label>
                <input type="number" class="special-episodes" value="${specialData ? specialData.episodes : 1}" min="1" max="100">
            </div>
            <div class="season-field full-width">
                <label>–°—Å—ã–ª–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞</label>
                <input type="url" class="special-link" value="${specialData ? specialData.link : ''}" placeholder="https://example.com/special1">
            </div>
        </div>
    `;
    
    specialsList.appendChild(specialEditor);
}

function removeSeason(button) {
    const seasonEditor = button.closest('.season-editor-item');
    seasonEditor.remove();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å–µ–∑–æ–Ω–æ–≤
    const seasonsList = document.getElementById('seasonsList');
    Array.from(seasonsList.children).forEach((editor, index) => {
        editor.querySelector('.season-number').textContent = `–°–µ–∑–æ–Ω ${index + 1}`;
    });
}

function removeSpecial(button) {
    const specialEditor = button.closest('.season-editor-item');
    specialEditor.remove();
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å–ø–µ—à–ª–æ–≤
    const specialsList = document.getElementById('specialsList');
    Array.from(specialsList.children).forEach((editor, index) => {
        editor.querySelector('.season-number').textContent = `–°–ø–µ—à–ª ${index + 1}`;
    });
}

function getSeasonsData() {
    const seasonsList = document.getElementById('seasonsList');
    const seasons = [];
    
    Array.from(seasonsList.children).forEach(editor => {
        const name = editor.querySelector('.season-name').value;
        const episodes = parseInt(editor.querySelector('.season-episodes').value);
        const link = editor.querySelector('.season-link').value;
        
        if (name && link) {
            seasons.push({
                name,
                episodes,
                link
            });
        }
    });
    
    return seasons;
}

function getSpecialsData() {
    const specialsList = document.getElementById('specialsList');
    const specials = [];
    
    Array.from(specialsList.children).forEach(editor => {
        const name = editor.querySelector('.special-name').value;
        const type = editor.querySelector('.special-type').value;
        const episodes = parseInt(editor.querySelector('.special-episodes').value);
        const link = editor.querySelector('.special-link').value;
        
        if (name && link) {
            specials.push({
                name,
                type,
                episodes,
                link
            });
        }
    });
    
    return specials;
}

function loadSeasonsData(seasons) {
    const seasonsList = document.getElementById('seasonsList');
    seasonsList.innerHTML = '';
    
    if (seasons && seasons.length > 0) {
        seasons.forEach(season => {
            addSeason(season);
        });
    } else {
        addSeason(); // –î–æ–±–∞–≤–ª—è–µ–º –æ–¥–∏–Ω —Å–µ–∑–æ–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
}

function loadSpecialsData(specials) {
    const specialsList = document.getElementById('specialsList');
    specialsList.innerHTML = '';
    
    if (specials && specials.length > 0) {
        specials.forEach(special => {
            addSpecial(special);
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π
function toggleDetails(element) {
    const animeItem = element.closest('.anime-item');
    const detailsSection = animeItem.querySelector('.details-section');
    const isExpanded = animeItem.classList.contains('expanded');
    
    if (isExpanded) {
        animeItem.classList.remove('expanded');
        element.textContent = 'üìã –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏';
    } else {
        animeItem.classList.add('expanded');
        element.textContent = 'üìã –°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function toggleComments(element) {
    const commentsSection = element.closest('.comments-section');
    const commentForm = commentsSection.querySelector('.comment-form');
    const commentsList = commentsSection.querySelector('.comments-list');
    const showMoreButton = commentsSection.querySelector('.show-more-comments');
    
    const isVisible = commentForm.style.display !== 'none';
    
    if (isVisible) {
        commentForm.style.display = 'none';
        commentsList.style.display = 'none';
        if (showMoreButton) showMoreButton.style.display = 'none';
    } else {
        commentForm.style.display = 'block';
        commentsList.style.display = 'block';
        if (showMoreButton) showMoreButton.style.display = 'block';
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞—Ç—ã
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ü–µ–Ω–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function openCommentRatingModal(animeIndex) {
    const commentInput = document.getElementById(`commentInput-${animeIndex}`);
    const commentText = commentInput.value.trim();
    
    if (!commentText) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
        return;
    }
    
    currentCommentAnimeIndex = animeIndex;
    document.getElementById('commentRatingText').value = commentText;
    document.getElementById('commentRatingModal').style.display = 'block';
    setupCommentRatingStars();
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—Ü–µ–Ω–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function closeCommentRatingModal() {
    document.getElementById('commentRatingModal').style.display = 'none';
    currentCommentAnimeIndex = -1;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤–µ–∑–¥ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function setupCommentRatingStars() {
    const stars = document.querySelectorAll('#commentRatingStars .rating-star');
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            setCommentRatingStars(rating);
        });
        
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            highlightCommentStars(rating);
        });
    });
    
    document.getElementById('commentRatingStars').addEventListener('mouseleave', function() {
        const currentRating = parseInt(document.getElementById('commentRating').value);
        highlightCommentStars(currentRating);
    });
}

function setCommentRatingStars(rating) {
    document.getElementById('commentRating').value = rating;
    document.getElementById('commentRatingValue').textContent = `${rating}/5`;
    highlightCommentStars(rating);
}

function highlightCommentStars(rating) {
    const stars = document.querySelectorAll('#commentRatingStars .rating-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
            star.textContent = '‚≠ê';
        } else {
            star.classList.remove('active');
            star.textContent = '‚òÜ';
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è —Å –æ—Ü–µ–Ω–∫–æ–π
function submitCommentWithRating() {
    const rating = parseInt(document.getElementById('commentRating').value);
    const commentText = document.getElementById('commentRatingText').value.trim();
    
    if (rating === 0) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É');
        return;
    }
    
    if (!commentText) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
        return;
    }
    
    if (currentCommentAnimeIndex === -1) return;
    
    const anime = animeList[currentCommentAnimeIndex];
    if (!anime.comments) {
        anime.comments = [];
    }
    
    const newComment = {
        author: currentUser.username,
        avatar: currentUser.avatar,
        text: commentText,
        date: new Date().toISOString().replace('T', ' ').substring(0, 16),
        rating: rating
    };
    
    anime.comments.unshift(newComment);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∞–Ω–∏–º–µ
    updateAnimeRating(anime);
    
    saveToLocalStorage();
    displayAnimeList(animeList);
    closeCommentRatingModal();
    
    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
    document.getElementById(`commentInput-${currentCommentAnimeIndex}`).value = '';
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function editComment(animeIndex, commentIndex) {
    const comment = animeList[animeIndex].comments[commentIndex];
    const commentElement = document.getElementById(`comment-${animeIndex}-${commentIndex}`);
    
    commentElement.innerHTML = `
        <div class="comment-author">
            <img src="${comment.avatar}" alt="–ê–≤–∞—Ç–∞—Ä" class="author-avatar">
            ${comment.author}
            ${comment.rating ? `<span class="comment-rating-badge">‚≠ê ${comment.rating}/5</span>` : ''}
        </div>
        <div class="comment-edit-form">
            <textarea class="comment-edit-input">${comment.text}</textarea>
            <div class="comment-edit-buttons">
                <button class="save-edit-btn" onclick="saveCommentEdit(${animeIndex}, ${commentIndex})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="cancel-edit-btn" onclick="displayAnimeList(animeList)">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
        <div class="comment-date">${formatDate(comment.date)}</div>
    `;
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function saveCommentEdit(animeIndex, commentIndex) {
    const commentElement = document.getElementById(`comment-${animeIndex}-${commentIndex}`);
    const editInput = commentElement.querySelector('.comment-edit-input');
    const newText = editInput.value.trim();
    
    if (!newText) {
        alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º');
        return;
    }
    
    animeList[animeIndex].comments[commentIndex].text = newText;
    animeList[animeIndex].comments[commentIndex].date = new Date().toISOString().replace('T', ' ').substring(0, 16);
    
    saveToLocalStorage();
    displayAnimeList(animeList);
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
function deleteComment(animeIndex, commentIndex) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π?')) {
        return;
    }
    
    const deletedComment = animeList[animeIndex].comments[commentIndex];
    animeList[animeIndex].comments.splice(commentIndex, 1);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–π—Ç–∏–Ω–≥ –∞–Ω–∏–º–µ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    updateAnimeRating(animeList[animeIndex]);
    
    saveToLocalStorage();
    displayAnimeList(animeList);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
function showAllComments(animeIndex) {
    const anime = animeList[animeIndex];
    const commentsHTML = generateCommentsHTML(anime, animeIndex);
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content">
            <h2 style="margin-bottom: 15px; color: #d63384;">üí¨ –í—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ "${anime.title}"</h2>
            <div class="comments-list" style="max-height: 350px;">
                ${commentsHTML}
            </div>
            <div class="btn-group" style="margin-top: 15px;">
                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                ${isAdmin && anime.comments && anime.comments.length > 0 ? 
                    `<button class="btn btn-primary" onclick="clearAllComments(${animeIndex})">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</button>` : ''}
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ (–¥–ª—è –∞–¥–º–∏–Ω–∞)
function clearAllComments(animeIndex) {
    if (!isAdmin) return;
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ —ç—Ç–æ–º—É –∞–Ω–∏–º–µ?')) {
        animeList[animeIndex].comments = [];
        updateAnimeRating(animeList[animeIndex]);
        saveToLocalStorage();
        displayAnimeList(animeList);
        document.querySelector('.modal').remove();
    }
}

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–≤–∞—Ç–∞—Ä–∞
document.getElementById('avatarInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentUser.avatar = e.target.result;
            document.getElementById('userAvatar').src = e.target.result;
            saveUserToLocalStorage();
        };
        reader.readAsDataURL(file);
    }
});

// –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ–Ω–∞
document.getElementById('backgroundInput').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            currentUser.background = e.target.result;
            document.body.classList.add('custom-bg');
            document.body.style.setProperty('--custom-bg', `url(${e.target.result})`);
            saveUserToLocalStorage();
            showNotification('–§–æ–Ω —É—Å–ø–µ—à–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! üé®');
        };
        reader.readAsDataURL(file);
    }
});

// –§—É–Ω–∫—Ü–∏—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–∫–≤–∏–∑–∏—Ç–æ–≤
function copyToClipboard(text) {
    navigator.clipboard.writeText(text.replace(/\s/g, '')).then(() => {
        showCopyNotification();
    });
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–∏
function showCopyNotification() {
    const notification = document.getElementById('copyNotification');
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 2000);
}

// –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ–±—ã—á–Ω–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function showNotification(message) {
    const notification = document.getElementById('copyNotification');
    notification.textContent = message;
    notification.classList.add('show');
    setTimeout(() => {
        notification.classList.remove('show');
    }, 2000);
}

// –§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∞–Ω–∏–º–µ
function editAnime(index) {
    if (!isAdmin) return;
    
    const anime = animeList[index];
    currentEditIndex = index;
    
    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∞–Ω–∏–º–µ';
    document.getElementById('modalSubmit').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
    document.getElementById('editIndex').value = index;
    
    document.getElementById('animeTitle').value = anime.title;
    document.getElementById('animeStudio').value = anime.studio;
    document.getElementById('animeVoiceType').value = anime.voiceType;
    document.getElementById('animeVoiceYear').value = anime.voiceYear;
    document.getElementById('animeDescription').value = anime.description;
    document.getElementById('animePosterUrl').value = '';
    document.getElementById('animeVoiceActors').value = anime.voiceActors ? anime.voiceActors.join('\n') : '';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–µ–π—Ç–∏–Ω–≥
    document.getElementById('animeRating').value = anime.rating;
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–≤–µ–∑–¥—ã —Ä–µ–π—Ç–∏–Ω–≥–∞
    setRatingStars(anime.rating || 0);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –ø—Ä–µ–≤—å—é
    document.getElementById('imagePreview').innerHTML = `<img src="${anime.poster}" alt="–ü—Ä–µ–≤—å—é">`;
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–µ–∑–æ–Ω—ã
    loadSeasonsData(anime.seasons);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–µ—à–ª—ã
    loadSpecialsData(anime.specials);
    
    openModal();
}

// –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∞–Ω–∏–º–µ
function deleteAnime(index) {
    if (!isAdmin) return;
    
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∞–Ω–∏–º–µ?')) {
        animeList.splice(index, 1);
        saveToLocalStorage();
        displayAnimeList(animeList);
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Ç–∏–ø–∞ –æ–∑–≤—É—á–∫–∏
function getVoiceTypeText(type) {
    const types = {
        'dub': '–î—É–±–ª—è–∂',
        'recap': '–†–µ–∫–∞—Å—Ç',
        'offscreen': '–ó–∞–∫–∞–¥—Ä–æ–≤–∞—è'
    };
    return types[type] || type;
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
function setFilter(filter) {
    currentFilter = filter;
    updateFilterButtons();
    displayAnimeList(animeList);
}

function toggleBestFilter() {
    currentBestFilter = !currentBestFilter;
    updateFilterButtons();
    displayAnimeList(animeList);
}

function setYearFilter(filter) {
    currentYearFilter = filter;
    updateFilterButtons();
    displayAnimeList(animeList);
}

function updateFilterButtons() {
    const filterButtons = document.querySelectorAll('.filter-btn');
    filterButtons.forEach(btn => {
        btn.classList.remove('active');
    });
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ —Ç–∏–ø—É
    if (currentFilter !== 'all') {
        document.querySelector(`.filter-btn[onclick="setFilter('${currentFilter}')"]`).classList.add('active');
    } else {
        document.querySelector('.filter-btn[onclick="setFilter(\'all\')"]').classList.add('active');
    }
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É "–õ—É—á—à–µ–µ" –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
    if (currentBestFilter) {
        document.getElementById('bestFilter').classList.add('active');
    }
    
    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ñ–∏–ª—å—Ç—Ä–∞ –ø–æ –≥–æ–¥—É –µ—Å–ª–∏ –æ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–∞
    if (currentYearFilter !== 'none') {
        document.getElementById(`${currentYearFilter}Filter`).classList.add('active');
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞
function setupRatingStars() {
    const stars = document.querySelectorAll('.rating-star');
    stars.forEach(star => {
        star.addEventListener('click', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            setRatingStars(rating);
        });
        
        star.addEventListener('mouseover', function() {
            const rating = parseInt(this.getAttribute('data-rating'));
            highlightStars(rating);
        });
    });
    
    document.getElementById('ratingStars').addEventListener('mouseleave', function() {
        const currentRating = parseInt(document.getElementById('animeRating').value);
        highlightStars(currentRating);
    });
}

function setRatingStars(rating) {
    document.getElementById('animeRating').value = rating;
    document.getElementById('ratingValue').textContent = `${rating}/5`;
    highlightStars(rating);
}

function highlightStars(rating) {
    const stars = document.querySelectorAll('.rating-star');
    stars.forEach((star, index) => {
        if (index < rating) {
            star.classList.add('active');
            star.textContent = '‚≠ê';
        } else {
            star.classList.remove('active');
            star.textContent = '‚òÜ';
        }
    });
}

// –§—É–Ω–∫—Ü–∏–∏ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
function toggleAdminMode() {
    document.getElementById('loginModal').classList.add('active');
}

function loginAdmin(login, password) {
    if (login === ADMIN_LOGIN && password === ADMIN_PASSWORD) {
        isAdmin = true;
        updateAdminUI();
        displayAnimeList(animeList);
        closeLoginModal();
        showNotification('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å! üëë');
        return true;
    }
    return false;
}

function logoutAdmin() {
    isAdmin = false;
    updateAdminUI();
    displayAnimeList(animeList);
    showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏');
}

function updateAdminUI() {
    const adminPanel = document.getElementById('adminPanel');
    const adminAccessBtn = document.getElementById('adminAccessBtn');
    
    if (isAdmin) {
        adminPanel.style.display = 'block';
        adminAccessBtn.style.display = 'none';
    } else {
        adminPanel.style.display = 'none';
        adminAccessBtn.style.display = 'block';
    }
}

// –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
function openModal() {
    document.getElementById('animeModal').style.display = 'block';
}

function openAddModal() {
    if (!isAdmin) return;
    
    document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∏–º–µ';
    document.getElementById('modalSubmit').textContent = '–î–æ–±–∞–≤–∏—Ç—å';
    document.getElementById('editIndex').value = '-1';
    document.getElementById('animeForm').reset();
    document.getElementById('imagePreview').innerHTML = '<span style="color: #f8bbd9;">–ü—Ä–µ–≤—å—é –ø–æ—Å—Ç–µ—Ä–∞</span>';
    setRatingStars(0);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–µ–∑–æ–Ω—ã –∏ —Å–ø–µ—à–ª—ã
    loadSeasonsData([]);
    loadSpecialsData([]);
    
    openModal();
}

function closeModal() {
    document.getElementById('animeModal').style.display = 'none';
    currentEditIndex = -1;
}

function closeLoginModal() {
    document.getElementById('loginModal').classList.remove('active');
    document.getElementById('loginForm').reset();
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –≤—Ö–æ–¥–∞
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const login = document.getElementById('adminLogin').value;
    const password = document.getElementById('adminPassword').value;
    
    if (!loginAdmin(login, password)) {
        alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å!');
    }
});

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –∞–Ω–∏–º–µ
document.getElementById('animeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    if (!isAdmin) return;
    
    const title = document.getElementById('animeTitle').value;
    const studio = document.getElementById('animeStudio').value;
    const voiceType = document.getElementById('animeVoiceType').value;
    const voiceYear = parseInt(document.getElementById('animeVoiceYear').value);
    const description = document.getElementById('animeDescription').value;
    const voiceActorsText = document.getElementById('animeVoiceActors').value;
    const rating = parseInt(document.getElementById('animeRating').value);
    const editIndex = document.getElementById('editIndex').value;
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
    try {
        validateAnimeData({ title, studio, voiceYear });
    } catch (error) {
        alert(error.message);
        return;
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∞–Ω–∏–º–µ "–ª—É—á—à–∏–º" (—Ä–µ–π—Ç–∏–Ω–≥ 4+)
    const isBest = rating >= 4;
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∞–∫—Ç–µ—Ä—ã –æ–∑–≤—É—á–∫–∏
    const voiceActors = voiceActorsText
        .split('\n')
        .filter(line => line.trim() !== '')
        .map(line => line.trim());
    
    // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å—Ç–µ—Ä –∏–∑ URL –∏–ª–∏ —Ñ–∞–π–ª–∞
    const posterUrl = document.getElementById('animePosterUrl').value;
    const posterFile = document.getElementById('animePosterFile').files[0];
    
    let poster = posterUrl;
    
    if (posterFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            poster = e.target.result;
            saveAnime(title, studio, voiceType, voiceYear, description, voiceActors, poster, rating, isBest, editIndex);
        };
        reader.readAsDataURL(posterFile);
    } else {
        // –ï—Å–ª–∏ URL –Ω–µ —É–∫–∞–∑–∞–Ω –∏ —ç—Ç–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–æ—Å—Ç–µ—Ä
        if (!poster && editIndex !== '-1') {
            poster = animeList[editIndex].poster;
        }
        saveAnime(title, studio, voiceType, voiceYear, description, voiceActors, poster, rating, isBest, editIndex);
    }
});

// –§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∞–Ω–∏–º–µ
function validateAnimeData(data) {
    if (!data.title || data.title.length < 1) {
        throw new Error('–ù–∞–∑–≤–∞–Ω–∏–µ –∞–Ω–∏–º–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
    }
    if (!data.studio || data.studio.length < 1) {
        throw new Error('–°—Ç—É–¥–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞');
    }
    if (data.voiceYear < 1990 || data.voiceYear > new Date().getFullYear() + 1) {
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≥–æ–¥ –æ–∑–≤—É—á–∫–∏');
    }
    return true;
}

function saveAnime(title, studio, voiceType, voiceYear, description, voiceActors, poster, rating, isBest, editIndex) {
    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å–µ–∑–æ–Ω–æ–≤ –∏ —Å–ø–µ—à–ª–æ–≤
    const seasons = getSeasonsData();
    const specials = getSpecialsData();
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–æ—Å—Ç–µ—Ä–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∑–∞–≥–ª—É—à–∫—É
    if (!poster) {
        poster = `https://via.placeholder.com/1000x1500/ffeef2/d63384?text=${encodeURIComponent(title)}`;
    }
    
    const animeData = {
        title,
        studio,
        voiceType,
        voiceYear,
        description,
        poster,
        voiceActors,
        rating,
        isBest,
        seasons,
        specials,
        comments: editIndex !== '-1' ? animeList[editIndex].comments || [] : [],
        commentRatings: editIndex !== '-1' ? animeList[editIndex].commentRatings || {
            total: 0,
            average: 0,
            distribution: {5: 0, 4: 0, 3: 0, 2: 0, 1: 0}
        } : {
            total: 0,
            average: 0,
            distribution: {5: 0, 4: 0, 3: 0, 2: 0, 1: 0}
        }
    };
    
    if (editIndex === '-1') {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–Ω–∏–º–µ
        animeList.push(animeData);
        showNotification('–ê–Ω–∏–º–µ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ! ‚úÖ');
    } else {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∞–Ω–∏–º–µ
        animeList[editIndex] = animeData;
        showNotification('–ê–Ω–∏–º–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ! ‚úèÔ∏è');
    }
    
    saveToLocalStorage();
    displayAnimeList(animeList);
    closeModal();
}

// –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
document.getElementById('animePosterFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('imagePreview').innerHTML = `<img src="${e.target.result}" alt="–ü—Ä–µ–≤—å—é">`;
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('animePosterUrl').addEventListener('input', function(e) {
    const url = e.target.value;
    if (url) {
        document.getElementById('imagePreview').innerHTML = `<img src="${url}" alt="–ü—Ä–µ–≤—å—é" onerror="this.parentElement.innerHTML='<span style=\\'color: #f8bbd9;\\'>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</span>'">`;
    }
});

// –ü–æ–∏—Å–∫ —Å –¥–µ–±–∞—É–Ω—Å–æ–º
document.getElementById('searchInput').addEventListener('input', function(e) {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredList = animeList.filter(anime => 
            anime.title.toLowerCase().includes(searchTerm) ||
            anime.studio.toLowerCase().includes(searchTerm) ||
            anime.description.toLowerCase().includes(searchTerm) ||
            (anime.voiceActors && anime.voiceActors.some(actor => 
                actor.toLowerCase().includes(searchTerm)
            )) ||
            (anime.comments && anime.comments.some(comment =>
                comment.text.toLowerCase().includes(searchTerm) ||
                comment.author.toLowerCase().includes(searchTerm)
            ))
        );
        displayAnimeList(filteredList);
    }, 300);
});

// Local Storage —Ñ—É–Ω–∫—Ü–∏–∏
function saveToLocalStorage() {
    localStorage.setItem('animeList', JSON.stringify(animeList));
}

function loadFromLocalStorage() {
    const saved = localStorage.getItem('animeList');
    if (saved) {
        return JSON.parse(saved);
    }
    return null;
}

function saveUserToLocalStorage() {
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
}

function loadUserFromLocalStorage() {
    const saved = localStorage.getItem('currentUser');
    if (saved) {
        return JSON.parse(saved);
    }
    return null;
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
const savedData = loadFromLocalStorage();
if (savedData) {
    animeList = savedData;
}

const savedUser = loadUserFromLocalStorage();
if (savedUser) {
    currentUser = savedUser;
    document.getElementById('usernameInput').value = currentUser.username;
    document.getElementById('userAvatar').src = currentUser.avatar;
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–æ–Ω –µ—Å–ª–∏ –µ—Å—Ç—å
    if (currentUser.background) {
        document.body.classList.add('custom-bg');
        document.body.style.setProperty('--custom-bg', `url(${currentUser.background})`);
    }
}

// –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
setupRatingStars();
updateAdminUI();
displayAnimeList(animeList);
updateFilterButtons();

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
window.addEventListener('click', function(e) {
    if (e.target === document.getElementById('animeModal')) {
        closeModal();
    }
    if (e.target === document.getElementById('loginModal')) {
        closeLoginModal();
    }
    if (e.target === document.getElementById('commentRatingModal')) {
        closeCommentRatingModal();
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Å–µ–∑–æ–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    loadSeasonsData([]);
    loadSpecialsData([]);
});
